# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem                  1.0
name                        rawtherapee
version                     4.0.9
revision                    188
platforms                   darwin
categories                  graphics
maintainers                 Makoto Yoshida
license                     GPL-3
description                 The powerful 64-bit open source raw converter
long_description            RawTherapee is a cross platform image processing software equipped with \
                            the essential tools for high quality and efficient RAW photo development.

use_parallel_build          yes
universal_variant           no

homepage                    http://rawtherapee.com
use_zip                     yes

depends_build               port:pkgconfig \
                            port:gcc47 \
                            port:cmake \
                            port:mercurial

depends_lib                 port:gtk2 \
                            port:gtkmm \
                            port:gtk-engines2 \
                            port:lcms2 \
                            port:libiptcdata \
                            port:fftw-3-single

variant devel {
    depends_fetch           port:mercurial
}

if {![variant_isset devel]} {
    master_sites            http://rawtherapee.googlecode.com/archive
    distfiles               924d2a8c79e00b60e5af275dcfb44587fe2d9c42.zip
    post-extract {
        move ${workpath}/rawtherapee-924d2a8c79e0 ${workpath}/${distname}
    }
} else {
    fetch.type              hg
    hg.url                  https://code.google.com/p/rawtherapee/
    hg.tag                  tip
}

patch_sites                 https://raw.github.com/mattintosh4/RawTherapee/master/macports/files
patchfiles                  patch-CMakeLists.txt.diff
checksums                   924d2a8c79e00b60e5af275dcfb44587fe2d9c42.zip \
                            md5 87bca5ae08b8aa3b5252e034b9237a28 \
                            patch-CMakeLists.txt.diff \
                            md5 d1a6dc5e5e55bab2f53609bd413b0a50

build.dir                   ${worksrcpath}/build
configure.dir               ${build.dir}

pre-configure {
    xinstall -d -m 0755 ${build.dir}
}

configure.cmd               cmake
configure.compiler          macports-gcc-4.7
configure.pre_args-delete   --prefix=${prefix}
configure.optflags-delete   -O2

set origin ${destroot}${prefix}/libexec/${distname}

configure.args              -D BUNDLE_BASE_INSTALL_DIR=${origin} \
                            -D CMAKE_BUILD_TYPE=Release \
                            -D PROC_TARGET_NUMBER=1 \
                            -D CMAKE_OSX_ARCHITECTURES=x86_64 \
                            -D CMAKE_VERBOSE_MAKEFILE=ON

configure.post_args         ${worksrcpath}

build.target                install

destroot {
    # create launch script
    set launcher ${destroot}${prefix}/bin/${name}
    system "printf 'DYLD_LIBRARY_PATH=%s %s \"$@\"\n' ${prefix}/lib/gcc47 ${prefix}/libexec/${distname}/${name} > ${launcher}"
    system "chmod +x ${launcher}"
    
    # install doc files
    set doc_dir ${destroot}${prefix}/share/doc/${name}
    xinstall -d ${doc_dir}
    xinstall -m 0644 ${worksrcpath}/doc/RawTherapeeManual_en.pdf ${doc_dir}
    
    # install man files
    xinstall -m 0644 ${worksrcpath}/doc/manpage/${name}.1 ${destroot}${prefix}/share/man/man1
    file delete -force ${origin}/share/man
}

platform darwin 10 {
    configure.args-append   -D CMAKE_OSX_DEPLOYMENT_TARGET=10.6 \
                            -D CMAKE_OSX_SYSROOT=/Developer/SDKs/MacOSX10.6.sdk
}
platform darwin 11 {
    configure.args-append   -D CMAKE_OSX_DEPLOYMENT_TARGET=10.7 \
                            -D CMAKE_OSX_SYSROOT=/Developer/SDKs/MacOSX10.7.sdk
}