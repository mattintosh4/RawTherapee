# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem                  1.0

name                        rawtherapee
version                     4.0.9
categories                  graphics
license                     GPL-3
description                 The powerful 64-bit open source raw converter
long_description            RawTherapee is a cross platform image processing software equipped with \
                            the essential tools for high quality and efficient RAW photo development.

platforms                   darwin
maintainers                 openmaintainer

use_parallel_build          yes
universal_variant           no

homepage                    http://rawtherapee.com

depends_build               port:pkgconfig \
                            port:gcc47 \
                            port:cmake \
                            port:mercurial

depends_lib                 port:gtk2 \
                            port:gtkmm \
                            port:gtk-engines2 \
                            port:lcms2 \
                            port:libiptcdata \
                            port:fftw-3-single

fetch.type                  hg
hg.url                      https://code.google.com/p/rawtherapee/
hg.tag                      tip

patch_sites                 https://raw.github.com/mattintosh4/RawTherapee/master/macports/files
patchfiles                  patch-CMakeLists.txt.diff

checksums                   patch-CMakeLists.txt.diff \
                            md5 d1a6dc5e5e55bab2f53609bd413b0a50

build.dir                   ${worksrcpath}/build
configure.dir               ${build.dir}

pre-configure {
    xinstall -d -m 0755 ${build.dir}
}

configure.cmd               cmake
configure.compiler          macports-gcc-4.7
configure.pre_args-delete   --prefix=${prefix}
configure.optflags-delete   -O2

set origin ${destroot}${prefix}/libexec/${distname}

# *** CMAKE_BUILD_TYPE ***
# Release: -O3 -DNDEBUG
# Debug: -g
# RELWITHDEBINFO: -O2 -g -DNDEBUG
set build_type RELWITHDEBINFO

# *** PROC_TARGET_NUMBER ***
# 0: none
# 1: -mtune=generic
# 2: -march=native
# 3: -march=pentium
# 4: -march=pentium4
# 5: -march=core2
# 6: -march=corei7
set proc_target 2

configure.args              -D BUNDLE_BASE_INSTALL_DIR=${origin} \
                            -D CMAKE_BUILD_TYPE=${build_type} \
                            -D PROC_TARGET_NUMBER=${proc_target} \
                            -D CMAKE_VERBOSE_MAKEFILE=ON

configure.post_args         ${worksrcpath}

build.target                install

destroot {
    # create launch script
    set launcher ${destroot}${prefix}/bin/${name}
    system "printf 'DYLD_LIBRARY_PATH=%s %s \"$@\"\n' ${prefix}/lib/gcc47 ${prefix}/libexec/${distname}/${name} > ${launcher}"
    system "chmod +x ${launcher}"
    
    # install doc files
    set doc_dir ${destroot}${prefix}/share/doc/${name}
    xinstall -d ${doc_dir}
    xinstall -m 0644 ${worksrcpath}/doc/RawTherapeeManual_en.pdf ${doc_dir}
    
    # install man files
    xinstall -m 0644 ${worksrcpath}/doc/manpage/${name}.1 ${destroot}${prefix}/share/man/man1
    file delete -force ${origin}/share/man
}
